<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="certReq">

	<sql id="certReqList_find">
		WHERE 1 = 1
		AND bin_stats_cd='DRAFT'
		<if test="companyID !='' and companyID != null">
			AND com_id = '${companyID}'
		</if>
        <if test="companyName !='' and companyName != null">
          AND com_id IN (select com_id from khm_com where com_name LIKE '%${companyName}%')
        </if>         
        <if test="brandTypeCode !='' and brandTypeCode != null">
           AND brand_type_cd = '${brandTypeCode}'
        </if>  
        <if test="binNumber != '' and binNumber != null">
        	AND bin_no like '%${binNumber}%'
        </if> 
        <if test="trackingNumber != '' and trackingNumber != null">
        	AND trk_no like '%${trackingNumber}%'
        </if> 
        <if test="ipkIndex != '' and ipkIndex != null and ipkIndex != '0'">
        	AND isuer_pk_index like '%${ipkIndex}%'
        </if> 
        <if test="ipkSize != '' and ipkSize != null and ipkSize != '0'">
        	AND isuer_pk_size like '%${ipkSize}%'
        </if> 
        <if test="periodType =='01'">
           AND TO_CHAR(certn_req_dt,'yyyy-MM-dd') BETWEEN NVL('${startDate}','1900-01-01') AND NVL('${endDate}','2999-12-31')
        </if>
        <if test="periodType =='02'">
           AND TO_CHAR(expie_dt,'yyyy-MM-dd') BETWEEN NVL('${startDate}','1900-01-01') AND NVL('${endDate}','2999-12-31')
        </if>
        <if test="periodType =='03'">
           AND TO_CHAR(reg_tmpst, 'yyyy-MM-dd') BETWEEN NVL('${startDate}','1900-01-01') AND NVL('${endDate}','2999-12-31')
        </if>                    
	</sql>
	
	<select id="getCertificateList" parameterType="com.kona.kms.web.cert.model.CertificateModel" resultType="com.kona.kms.web.cert.model.CertificateModel">
		SELECT *
		FROM (SELECT ROWNUM AS RNUM,
			         b.*
		      FROM (SELECT a.certn_uid           as certificateUID,
		      			   a.com_id              as companyID,		      			   
		      			   (select com_name from khm_com b where b.com_id=a.com_id) as companyName,		
		      			   a.certn_name          as certificateName,
		      			   a.brand_type_cd       as brandTypeCode,
		      			   a.bin_no              as binNumber,
		      			   a.trk_no              as trackingNumber,
		      			   a.isuer_pk_index      as ipkIndex,
		      			   a.isuer_pk_size       as ipkSize,
		      			   a.expie_dt            as expireDate,
		      			   a.certn_req_dt        as requestDate,  		
		      			   a.key_subject         as keySubject,			        			   
		      			   a.key_prof_id         as keyProfileID,
		      			   a.key_prof_ver        as keyProfileVersion,		
		      			   a.key_prof_name       as keyProfileName,      			   
		      			   a.certn_req_file_name as certiReqFileName,	
		      			   <!--       	
		      			   a.certn_req_biny_file as certiReqBinaryFile,	 
		      			   -->
		      			   a.certn_res_file_name as certiResFileName,
		      			   <!-- 
		      			   a.certn_res_biny_file as certiResBinaryFile,
		      			   -->
		      			   a.isuer_pk_exp_val    as exponentValue,
		      			   a.certn_hash_val      as hashValue,
		      			   a.bin_stats_cd        as binStatusCode,
		      			   a.req_send_stats_cd   as reqSendStatusCode,
		      			   a.res_send_stats_cd   as resSendStatusCode,	      			   	      			   
		      			   a.reg_user_id         as registrationUserID,
		      			   a.reg_tmpst           as registrationDate,
		      			   a.upd_user_id         as updateUserID,
		      			   a.upd_tmpst           as updateDate
		           FROM kky_certn a
		           <include refid="certReqList_find" />
		           ORDER BY ${sortname} ${sortorder}) b) c
		WHERE c.RNUM BETWEEN #{startRowNum} AND #{endRowNum} 
	</select>
		
	<select id="getTotalRecord" parameterType="com.kona.kms.web.cert.model.CertificateModel" resultType="Integer">
		SELECT COUNT(*) AS RECORD_COUNT
        FROM kky_certn
        <include refid="certReqList_find"/>
	</select>
	
	<select id="getCertificateListAll" parameterType="com.kona.kms.web.cert.model.CertificateModel" resultType="com.kona.kms.web.cert.model.CertificateModel">
		SELECT a.certn_uid           as certificateUID,
    		   a.com_id              as companyID,		      			   
    		   (select com_name from khm_com b where b.com_id=a.com_id) as companyName,		
    		   a.certn_name          as certificateName,
   			   a.brand_type_cd       as brandTypeCode,
   			   a.bin_no              as binNumber,
   			   a.trk_no              as trackingNumber,
   			   a.isuer_pk_index      as ipkIndex,
   			   a.isuer_pk_size       as ipkSize,
   			   a.expie_dt            as expireDate,
   			   a.certn_req_dt        as requestDate,  		
   			   a.key_subject         as keySubject,			        			   
   			   a.key_prof_id         as keyProfileID,
   			   a.key_prof_ver        as keyProfileVersion,		
   			   a.key_prof_name       as keyProfileName,      			   
   			   a.certn_req_file_name as certiReqFileName,	
   			   <!--       	
   			   a.certn_req_biny_file as certiReqBinaryFile,	 
   			   -->
   			   a.certn_res_file_name as certiResFileName,
   			   <!-- 
   			   a.certn_res_biny_file as certiResBinaryFile,
   			   -->
   			   a.isuer_pk_exp_val    as exponentValue,
   			   a.certn_hash_val      as hashValue,
   			   a.bin_stats_cd        as binStatusCode,
   			   a.req_send_stats_cd   as reqSendStatusCode,
   			   a.res_send_stats_cd   as resSendStatusCode,	      			   	      			   
   			   a.reg_user_id         as registrationUserID,
   			   a.reg_tmpst           as registrationDate,
   			   a.upd_user_id         as updateUserID,
   			   a.upd_tmpst           as updateDate
        FROM kky_certn a
        <include refid="certReqList_find" />
        ORDER BY ${sortname} ${sortorder}
	</select>
	
	<select id="getCertificate" parameterType="string" resultType="com.kona.kms.web.cert.model.CertificateModel">
		SELECT a.certn_uid           as certificateUID,
    		   a.com_id              as companyID,		      			   
    		   (select com_name from khm_com b where b.com_id=a.com_id) as companyName,		
    		   a.certn_name          as certificateName,
   			   a.brand_type_cd       as brandTypeCode,
   			   a.bin_no              as binNumber,
   			   a.trk_no              as trackingNumber,
   			   a.isuer_pk_index      as ipkIndex,
   			   a.isuer_pk_size       as ipkSize,
   			   a.expie_dt            as expireDate,
   			   a.certn_req_dt        as requestDate,  		
   			   a.key_subject         as keySubject,			        			   
   			   a.key_prof_id         as keyProfileID,
   			   a.key_prof_ver        as keyProfileVersion,		
   			   a.key_prof_name       as keyProfileName,      			   
   			   a.certn_req_file_name as certiReqFileName,
   			   a.certn_req_biny_file as certiReqBinaryFile,
   			   
   			   a.certn_res_file_name as certiResFileName,
   			   a.certn_res_biny_file as certiResBinaryFile,
   			   a.ca_serial_no		 as caSerialNumber,
   			   a.ca_pk_index		 as caPublicKeyIndex,
   			   a.ca_pk_len			 as caPublicKeyLength,
   			   
   			   
   			   
   			   
   			   a.isuer_pk_exp_val    as exponentValue,
   			   a.hash_val_file_name  as hashValueFileName,
   			   a.certn_hash_val      as hashValue,
   			   a.bin_stats_cd        as binStatusCode,
   			   a.req_send_stats_cd   as reqSendStatusCode,
   			   a.res_send_stats_cd   as resSendStatusCode,	      			   	      			   
   			   a.reg_user_id         as registrationUserID,
   			   a.reg_tmpst           as registrationDate,
   			   a.upd_user_id         as updateUserID,
   			   a.upd_tmpst           as updateDate
        FROM kky_certn a
        WHERE certn_uid=#{value}
	</select>
	
	<select id="getCertificateToTransfer" parameterType="string" resultType="com.kona.kms.web.cert.model.CertJobModel">
		<![CDATA[
		select certn_uid    as certificateUID,
			   certn_name   as certificateName,
			   work_code    as workcode,
			   try_cnt      as tryCount,
			   description  as description
		from kky_certn_send
		where certn_uid=#{value}
		]]>
	</select>
	
	
	<insert id="insertCertificate" parameterType="com.kona.kms.web.cert.model.CertificateModel">
		<![CDATA[
			insert into kky_certn(
			       certn_uid,
    		       com_id,		      			   		
    		       certn_name,
   			       brand_type_cd,
   			       bin_no,
   			       trk_no,
   			       isuer_pk_index,
   			       isuer_pk_size,
   			       expie_dt,
   			       certn_req_dt,  
   			       key_subject,			        			   
   			       key_prof_id,
   			       key_prof_ver,		
   			       key_prof_name,      			   
   			       certn_req_file_name,
   			       certn_req_biny_file,
   			       isuer_pk_exp_val,
   			       hash_val_file_name,
   			       certn_hash_val,
   			       bin_stats_cd,
   			       req_send_stats_cd,
   			       res_send_stats_cd,	      			   	      			   
   			       reg_user_id,
   			       reg_tmpst,
   			       upd_user_id,
   			       upd_tmpst
			)values(
				#{certificateUID},
   			    #{companyID},		      			
   			  	#{certificateName},
   			   	#{brandTypeCode},
   			   	#{binNumber},
   			  	#{trackingNumber},
   			   	#{ipkIndex},
   			   	#{ipkSize},
   			   	
   			   	#{expireDate},
   			   	#{requestDate},  
   			   	 
   			   	#{keySubject},	        			   
   			   	#{keyProfileID},
   			   	#{keyProfileVersion},   			   	
   			   	#{keyProfileName},		      			   
   			   	#{certiReqFileName},	      	
   			   	#{certiReqBinaryFile},	
   			   	#{exponentValue},
   			   	#{hashValueFileName},
   			   	#{hashValue},
   			   	#{binStatusCode},
   			   	#{reqSendStatusCode},
   			   	#{resSendStatusCode}, 	      			   	      			   
   			   	#{registrationUserID},
   			   	#{registrationDate},
   			   	#{updateUserID},
   			   	#{updateDate}
			)
		]]>
	</insert>
		
	<select id="checkBINAndIndexUnique" parameterType="java.util.Map" resultType="int">
		<![CDATA[
		select count(*)
		from kky_certn
		where bin_no=#{bin}
		      and isuer_pk_index=#{ipkIndex}
		      and expie_dt >= #{expireDate}
		      and bin_stats_cd <> 'DELETE'
		]]>
	</select>
	
	<delete id="deleteCertificate" parameterType="string">
		delete from kky_certn
		where certn_uid=#{value}
	</delete>
	
	<update id="setCertificateAsDelete" parameterType="string">
		update kky_certn set
		       bin_stats_cd = 'DELETE'
		where certn_uid=#{value}
	</update>
	
	<update id="updateCertificate" parameterType="com.kona.kms.web.cert.model.CertificateModel">
		update kky_certn
		set com_id              = #{companyID},		      			
   			certn_name          = #{certificateName},
 			brand_type_cd       = #{brandTypeCode},
 			bin_no              = #{binNumber},
 			trk_no              = #{trackingNumber},
 			isuer_pk_index      = #{ipkIndex},
 			isuer_pk_size       = #{ipkSize},
 			expie_dt            = #{expireDate},
 			certn_req_dt        = #{requestDate}, 		
 			key_subject         = #{keySubject},		        			   
 			key_prof_id         = #{keyProfileID},
 			key_prof_ver        = #{keyProfileVersion},
 			key_prof_name       = #{keyProfileName},		      			   
 			certn_req_file_name = #{certiReqFileName},	      	
 			certn_req_biny_file = #{certiReqBinaryFile},
 			isuer_pk_exp_val    = #{exponentValue},
   			certn_hash_val      = #{hashValue},
 			upd_user_id         = #{updateUserID},
 			upd_tmpst           = #{updateDate}
   		where certn_uid=#{certificateUID}
	</update>

</mapper>