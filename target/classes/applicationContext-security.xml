<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/security
                           http://www.springframework.org/schema/security/spring-security-3.1.xsd">

    <global-method-security secured-annotations="enabled" />



    <beans:bean id="languageFilter" class="com.kona.kms.web.LanguageFilter">
    	<beans:property name="authenticationManager" ref="authenticationManager" />
    	<beans:property name="authenticationSuccessHandler" ref="loginSuccessHandler" />
    	<beans:property name="authenticationFailureHandler" ref="failureHandler" />
    </beans:bean>
        

    <http entry-point-ref="loginUrlAuthenticationEntryPoint" use-expressions="true">       
        
        <!-- Restrict URLs based on role -->
        <intercept-url pattern="/favicon.ico" access="permitAll" />
        <intercept-url pattern="/" access="permitAll" />
        <intercept-url pattern="/logout" access="permitAll" />
        <intercept-url pattern="/welcome" access="permitAll" />
        <intercept-url pattern="/loginfailed" access="permitAll" />
        <intercept-url pattern="/js/**" access="permitAll" />
        <intercept-url pattern="/css/**" access="permitAll" />
        <intercept-url pattern="/img/**" access="permitAll" />
        <intercept-url pattern="/services/**" access="permitAll" />
        <intercept-url pattern="/kms/services/**" access="permitAll" />
        <intercept-url pattern="/crypto/**" access="permitAll" />
                
        <intercept-url pattern="/**" access="hasRole('KMS Manager') or hasRole('Key Manager')" />
		
		<custom-filter position="FORM_LOGIN_FILTER" ref="languageFilter"/>
		
		<logout logout-success-url="/" />
        
        <!-- Override default login and logout pages 
        <form-login login-page="/" 
                    default-target-url="/welcome" 
                    authentication-failure-url="/loginfailed" />
        <logout logout-success-url="/" />
        -->     
        
    </http> 
    
    <beans:bean id="loginSuccessHandler"
		class="org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler">
		<beans:property name="defaultTargetUrl" value="/welcome" />
	</beans:bean>
    
    <beans:bean id="loginUrlAuthenticationEntryPoint"
        class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
        <beans:property name="loginFormUrl" value="/" />
 	</beans:bean>  
 	
 	<beans:bean id="failureHandler"
      class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
       <beans:property name="defaultFailureUrl" value="/loginfailed" />
  	</beans:bean>

    <authentication-manager alias="authenticationManager">
        <authentication-provider user-service-ref="userDetailService">
        	<password-encoder hash="sha" />
        </authentication-provider>
    </authentication-manager>   
    
    <beans:bean id="userDetailService" class="com.kona.kms.web.UserDetailServiceImpl" init-method="init" /> 

	<!-- Password Encoder -->
	<beans:bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.ShaPasswordEncoder" />
</beans:beans>